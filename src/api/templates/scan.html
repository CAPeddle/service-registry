{% extends "base.html" %}

{% block title %}Scan Services - Service Registry{% endblock %}

{% block header %}Scan for Services{% endblock %}

{% block header_actions %}
<a href="/" class="btn">Back to Dashboard</a>
{% endblock %}

{% block extra_head %}
<style>
    .section {
        margin-bottom: 30px;
    }
    .section h2 {
        margin-bottom: 15px;
        color: #495057;
        font-size: 18px;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 8px;
    }
    .configure-btn {
        background: #28a745;
        color: white;
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        font-size: 14px;
    }
    .configure-btn:hover {
        background: #218838;
    }
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        align-items: center;
        justify-content: center;
    }
    .modal.active {
        display: flex;
    }
    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #495057;
    }
    .form-group input, .form-group textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }
    .form-group textarea {
        resize: vertical;
        min-height: 60px;
    }
    .form-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }
    .btn-secondary {
        background: #6c757d;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .btn-secondary:hover {
        background: #5a6268;
    }
    details {
        margin-top: 10px;
    }
    summary {
        cursor: pointer;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
        font-weight: 500;
    }
    summary:hover {
        background: #e9ecef;
    }
</style>
{% endblock %}

{% block content %}
<div class="section">
    <h2>Discovered Web Services</h2>
    {% if discovered %}
    <table>
        <thead>
            <tr>
                <th>Service Name</th>
                <th>Port</th>
                <th>State</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for service in discovered %}
            <tr>
                <td>{{ service.name }}</td>
                <td>{{ service.port or '-' }}</td>
                <td>{{ service.systemd_state }}</td>
                <td>
                    <button class="configure-btn" onclick="openConfigModal('{{ service.name }}', {{ service.port or 'null' }})">
                        Configure
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No new web services discovered. All detected services are already configured.</p>
    {% endif %}
</div>

<div class="section">
    <details>
        <summary>All Systemd Services ({{ all_services|length }})</summary>
        <table>
            <thead>
                <tr>
                    <th>Service Name</th>
                    <th>Status</th>
                    <th>State</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for service in all_services %}
                <tr>
                    <td>{{ service.name }}</td>
                    <td>{{ service.status }}</td>
                    <td>{{ service.systemd_state }}</td>
                    <td>
                        {% if service.status == 'raw' %}
                        <button class="configure-btn" onclick="openConfigModal('{{ service.name }}', null)">
                            Add to Registry
                        </button>
                        {% else %}
                        <span>{{ service.status }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </details>
</div>

<!-- Configuration Modal -->
<div id="configModal" class="modal">
    <div class="modal-content">
        <h2>Configure Service</h2>
        <form id="configForm">
            <div class="form-group">
                <label>Service Name</label>
                <input type="text" id="serviceName" readonly>
            </div>
            <div class="form-group">
                <label>Description *</label>
                <textarea id="description" required></textarea>
            </div>
            <div class="form-group">
                <label>Base URL *</label>
                <input type="url" id="baseUrl" placeholder="http://192.168.2.24:8080" required>
            </div>
            <div class="form-group">
                <label>Port</label>
                <input type="number" id="port" min="1" max="65535">
            </div>
            <div class="form-group">
                <label>Health Endpoint</label>
                <input type="text" id="healthEndpoint" placeholder="/health">
            </div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="closeConfigModal()">Cancel</button>
                <button type="submit" class="btn">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openConfigModal(name, port) {
        document.getElementById('serviceName').value = name;
        document.getElementById('port').value = port || '';
        if (port) {
            document.getElementById('baseUrl').value = `http://192.168.2.24:${port}`;
        }
        document.getElementById('configModal').classList.add('active');
    }

    function closeConfigModal() {
        document.getElementById('configModal').classList.remove('active');
        document.getElementById('configForm').reset();
    }

    document.getElementById('configForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const data = {
            name: document.getElementById('serviceName').value,
            description: document.getElementById('description').value,
            base_url: document.getElementById('baseUrl').value,
            port: parseInt(document.getElementById('port').value) || null,
            health_endpoint: document.getElementById('healthEndpoint').value || null
        };

        const response = await fetch('/api/services', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to save service');
        }
    });
</script>
{% endblock %}
